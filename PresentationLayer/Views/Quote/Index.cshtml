@model BookingRequestVM
@{
    ViewData["Title"] = "Báo giá Lưu kho";
}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="~/css/Booking.css" asp-append-version="true" />

<div class="quote-container">
    <div class="header">
        <h1>🏪 Shannon Storage</h1>
        <p>Tìm kho gần bạn nhất và đặt chỗ ngay!</p>
    </div>

    <div id="quotePage" class="quote-page">
        <div class="main-content">
            <div>
                <div class="map-section">
                    <h3>📍 Địa chỉ nhận hàng & Tìm kho gần bạn</h3>
                    <div style="background: #e8f0fe; padding: 12px; border-radius: 10px; margin-bottom: 15px; font-size: 0.9rem; color: #333;">
                        <strong>💡 Lưu ý:</strong> Đây là địa chỉ nhận hàng của bạn. Nhập địa chỉ hoặc chọn vị trí hiện tại để tìm các kho gần nhất.
                    </div>
                    <div class="location-search">
                        <input type="text" id="warehouseAreaInput" class="location-input" placeholder="Nhập địa chỉ nhận hàng (ví dụ: Dương Quảng Hàm, Hà Nội)...">
                        <div id="warehouseAreaResults" class="autocomplete-list"></div>
                        <button class="location-btn" onclick="searchLocation()">🔍 Tìm kiếm</button>
                        <button class="location-btn secondary" onclick="getCurrentLocation()">📍 Vị trí hiện tại</button>
                    </div>
                    <div id="map"></div>
                    <h4 style="color: #667eea; margin-bottom: 15px;">📦 Danh sách kho (sắp xếp theo khoảng cách)</h4>
                    <div class="warehouse-list" id="warehouseList"></div>
                </div>

                <div class="form-card">
                    <h2>📋 Thông tin lưu kho</h2>
                    <form id="quoteForm" method="post" action="/Quote/CreateWarehouseOrder" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <div class="form-group">
                            <label>Kho đã chọn <span class="required">*</span></label>
                            <input type="text" class="form-control" id="warehouseNameDisplay" placeholder="Chọn kho trên bản đồ" readonly>
                            <input type="hidden" id="warehouseIdInput" required>
                            
                        </div>

                        <div class="form-group">
                            <label>Thời gian lưu kho <span class="required">*</span></label>
                            <div class="date-range">
                                <div>
                                    <input type="date" class="form-control" id="storageStartDate" value="@Model.StorageStartDate.ToString("yyyy-MM-dd")" required>
                                    <small>Ngày gửi vào</small>
                                </div>
                                <div>
                                    <input type="date" class="form-control" id="storageEndDate" value="@Model.StorageEndDate.ToString("yyyy-MM-dd")" required>
                                    <small>Ngày lấy ra</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Thông tin liên hệ <span class="required">*</span></label>
                            <div class="contact-group">
                                <input type="text" class="form-control" id="customerName" placeholder="Họ và tên" value="@Model.CustomerFullName" required>
                                <input type="tel" class="form-control" id="customerPhone" placeholder="Số điện thoại" value="@Model.CustomerPhone" required>
                            </div>
                            <input type="email" class="form-control" id="customerEmail" placeholder="Email" value="@Model.CustomerEmail" style="margin-top: 10px;">
                        </div>

                        <div class="form-group">
                            <label>Ảnh tổng của toàn bộ sản phẩm (tùy chọn - để AI phân tích)</label>
                            <input type="file" id="productImageInput" accept="image/*" onchange="previewTotalImage(this)" class="form-control">
                            <div class="image-preview-container">
                                <img id="productImagePreview" class="image-preview" style="display: none;" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Danh sách đồ dùng cần lưu kho</label>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 0.9rem; color: #666;">
                                <strong>💡 Gợi ý:</strong> Nhập thông tin chi tiết để được báo giá chính xác. Ví dụ: "Bàn học sinh (gỗ mặt chữ nhật, chân kim loại)"
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                                    <thead>
                                        <tr style="background: #667eea; color: white;">
                                            <th style="padding: 10px; text-align: left; border-radius: 8px 0 0 0;">Tên đồ</th>
                                            <th style="padding: 10px; text-align: left;">Danh mục</th>
                                            <th style="padding: 10px; text-align: center; min-width: 100px;">Số lượng</th>
                                            <th style="padding: 10px; text-align: center; min-width: 100px;">Trọng lượng (Kg)</th>
                                            <th style="padding: 10px; text-align: center; min-width: 50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemsTableBody">
                                        @if (Model.Items != null && Model.Items.Count > 0)
                                        {
                                            @for (int i = 0; i < Model.Items.Count; i++)
                                            {
                                                <tr style="border-bottom: 1px solid #e0e0e0;">
                                                    <td style="padding: 10px;">
                                                        <input type="text" class="form-control" name="Items[@i].Name" value="@Model.Items[i].Name" placeholder="Ví dụ: Bàn học sinh">
                                                    </td>
                                                    <td style="padding: 10px;">
                                                        <input type="text" class="form-control" name="Items[@i].Category" value="@Model.Items[i].Category" placeholder="Ví dụ: Nội thất">
                                                    </td>
                                                    <td style="padding: 10px;">
                                                        <input type="number" class="form-control" name="Items[@i].Quantity" value="@Model.Items[i].Quantity" min="1" placeholder="1" style="text-align: center;">
                                                    </td>
                                                    <td style="padding: 10px;">
                                                        <input type="number" class="form-control" name="Items[@i].EstimatedWeightKg" value="@Model.Items[i].EstimatedWeightKg" min="0" step="0.1" placeholder="0" style="text-align: center;">
                                                    </td>
                                                    <td style="padding: 10px; text-align: center;">
                                                        <button type="button" class="location-btn" onclick="removeItemRow(this)" style="padding: 6px 10px; background: #e74c3c;">✖</button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="5" style="padding: 15px; text-align: center; color: #999; font-style: italic;">
                                                    Chưa có món nào. Nhấn "+ Thêm món" để thêm đồ dùng.
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" class="location-btn secondary" onclick="addItemRow()">+ Thêm món</button>
                                <button type="button" class="location-btn" onclick="loadSampleData()" style="background: #95a5a6;">📋 Load dữ liệu mẫu</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Yêu cầu đặc biệt</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" name="SpecialRequirements" value="🧊 Kho mát">
                                    <label>🧊 Kho mát</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="SpecialRequirements" value="💧 Chống ẩm">
                                    <label>💧 Chống ẩm</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="SpecialRequirements" value="🔒 An ninh cao">
                                    <label>🔒 An ninh cao</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="SpecialRequirements" value="🛡️ Bảo hiểm hàng hóa">
                                    <label>🛡️ Bảo hiểm hàng hóa</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="SpecialRequirements" value="🏢 Kho có thang máy">
                                    <label>🏢 Kho có thang máy</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="SpecialRequirements" value="📹 Giám sát 24/7">
                                    <label>📹 Giám sát 24/7</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Ghi chú</label>
                            <textarea class="form-control" id="orderNote" rows="3" placeholder="Ví dụ: đồ dễ vỡ, cần ưu tiên...">@Model.Note</textarea>
                        </div>

                        <button type="button" class="submit-btn secondary" onclick="showWarehouseSlots()">🗺️ Xem sơ đồ kho & chọn vị trí</button>
                        <button type="button" id="bookBtn" class="submit-btn" onclick="submitWarehouseOrder()">📊 Gửi yêu cầu</button>
                    </form>
                </div>

                <div class="warehouse-section" id="warehouseSlotSection">
                    <div class="warehouse-header">
                        <h3>🗺️ Sơ đồ kho và chọn vị trí</h3>
                        <button class="location-btn" onclick="toggleSlotSection()">✕ Đóng</button>
                    </div>
                    <div id="selectedWarehouseInfo" style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px; display: none;">
                        <strong>Kho đã chọn: </strong><span id="selectedWarehouseName">-</span>
                    </div>
                    <div class="warehouse-grid">
                        <div class="grid-container" id="warehouseGrid"></div>
                    </div>
                    <div id="selectedSlotsSummary" style="margin-top: 20px; padding: 15px; background: #e8f0fe; border-radius: 10px; display: none;">
                        <strong>Đã chọn slot:</strong> <span id="selectedSlotsList">Chưa chọn slot nào</span>
                    </div>
                </div>
            </div>

            <div class="estimation-card">
                <h3>💰 Tạm tính</h3>
                <div class="estimation-row"><span>Thời gian lưu trữ:</span><span id="estDays">0 ngày</span></div>
                <div class="estimation-row" style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
                    <strong style="color: #667eea;">📋 Dịch vụ đã chọn:</strong>
                </div>
                <div id="estAddonDetails" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;">
                    <div style="color: #999; font-style: italic; text-align: center; padding: 10px;">Chưa chọn dịch vụ nào</div>
                </div>
                <div class="estimation-row" style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
                    <span>Tổng dịch vụ (chưa VAT):</span><span id="estSubtotal">0 đ</span>
                </div>
                <div class="estimation-row"><span>VAT (10%):</span><span id="estVAT">0 đ</span></div>
                <div class="estimation-row total"><span>TỔNG DỊCH VỤ:</span><span id="estTotal">0 đ</span></div>
                <div class="info-box">
                    <p>⏰ <strong>Miễn phí 2 ngày đầu</strong></p>
                    <p>📦 Báo giá có hiệu lực trong 48 giờ</p>
                    <p>✅ Giá đã bao gồm VAT</p>
                </div>
            </div>
        </div>
    </div>

    <div id="breakdownPage" class="breakdown-page">
        <div class="breakdown-card"></div>
    </div>
</div>

<div id="slotDetailModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeSlotDetailModal()">×</button>
        <div id="slotDetailContent"></div>
    </div>
</div>

<div id="negotiateModal" class="modal">
    <div class="modal-content">
        <h3>💬 Yêu cầu chỉnh giá</h3>
        <p style="color: #666; margin-bottom: 20px;">Vui lòng nhập ghi chú yêu cầu:</p>
        <textarea id="negotiateNote" class="form-control" rows="5" placeholder="Ví dụ: Xin thêm 1 ngày miễn phí..."></textarea>
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button class="submit-btn" style="flex: 1; background: #ccc;" onclick="closeNegotiateModal()">Hủy</button>
            <button class="submit-btn" style="flex: 1;" onclick="submitNegotiate()">Gửi yêu cầu</button>
        </div>
    </div>
</div>

<div id="writeFeedbackModal" class="modal">
    <div class="modal-content">
        <h3>Đánh giá dịch vụ</h3>
        <div id="feedbackRating" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 30px;">
            <span class="star" data-value="1" style="font-size: 2.5rem; cursor: pointer; color: #fbbf24;">☆</span>
            <span class="star" data-value="2" style="font-size: 2.5rem; cursor: pointer; color: #fbbf24;">☆</span>
            <span class="star" data-value="3" style="font-size: 2.5rem; cursor: pointer; color: #fbbf24;">☆</span>
            <span class="star" data-value="4" style="font-size: 2.5rem; cursor: pointer; color: #fbbf24;">☆</span>
            <span class="star" data-value="5" style="font-size: 2.5rem; cursor: pointer; color: #fbbf24;">☆</span>
        </div>
        <label class="feedback-label">Điền ý kiến của bạn:</label>
        <textarea id="writeFeedbackComment" class="form-control" rows="5" placeholder="Ví dụ: Dịch vụ tốt, nhân viên nhiệt tình."></textarea>
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button class="submit-btn" style="flex: 1; background: #ccc;" onclick="closeFeedbackModal()">Hủy</button>
            <button class="submit-btn" style="flex: 1;" onclick="submitFeedback()">Gửi đánh giá</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
    // Đảm bảo Leaflet đã load xong trước khi chạy booking.js
    if (typeof L !== 'undefined') {
        console.log('✅ Leaflet loaded');
    } else {
        console.warn('⚠️ Leaflet not loaded yet');
    }
</script>
<script src="/js/booking.js" asp-append-version="true"></script>
<script>
    // Test functions để debug - có thể gọi từ console
    window.testLoadWarehouses = function(lat, lng) {
        if (window.bookingDebug && window.bookingDebug.loadNearbyWarehouses) {
            window.bookingDebug.loadNearbyWarehouses(lat || 21.028511, lng || 105.804817);
        } else {
            console.error('loadNearbyWarehouses function not found. Check bookingDebug object.');
        }
    };
    
    // Test function để kiểm tra map
    window.testMap = function() {
        console.log('=== MAP DEBUG INFO ===');
        console.log('Map element exists:', !!document.getElementById('map'));
        console.log('Leaflet loaded:', typeof L !== 'undefined');
        if (window.bookingDebug) {
            console.log('Map object:', window.bookingDebug.map());
            const map = window.bookingDebug.map();
            if (map) {
                console.log('Map center:', map.getCenter());
                console.log('Map zoom:', map.getZoom());
                console.log('Map bounds:', map.getBounds());
            } else {
                console.warn('Map is not initialized yet');
            }
            console.log('Nearby warehouses:', window.bookingDebug.nearbyWarehouses());
        } else {
            console.error('bookingDebug object not found');
        }
    };
    
    // Test API endpoint
    window.testWarehouseAPI = async function(lat, lng) {
        const url = `/Quote/NearbyWarehouses?lat=${lat || 21.028511}&lng=${lng || 105.804817}&take=10`;
        console.log('Testing API:', url);
        try {
            const response = await fetch(url);
            const data = await response.json();
            console.log('API Response:', data);
            console.log('Warehouses count:', data.length);
            return data;
        } catch (error) {
            console.error('API Error:', error);
        }
    };
</script>
