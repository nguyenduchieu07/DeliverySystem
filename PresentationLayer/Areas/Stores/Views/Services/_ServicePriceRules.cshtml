@using DataAccessLayer.Enums
@model ServiceEditViewModel

<style>
  .rules-grid{display:grid;grid-template-columns:140px 140px 90px 90px 90px 90px 90px 90px 80px 80px 120px 140px 120px;gap:8px;align-items:center}
  .rules-grid .head{font-size:12px;color:var(--muted);text-transform:uppercase}
  .rules-row{display:contents}
</style>

<div class="rules-grid" id="rulesGrid">
  <div class="head">Valid From</div>
  <div class="head">Valid To</div>
  <div class="head">Min m³</div>
  <div class="head">Max m³</div>
  <div class="head">Min m²</div>
  <div class="head">Max m²</div>
  <div class="head">Min Qty</div>
  <div class="head">Max Qty</div>
  <div class="head">Min Days</div>
  <div class="head">Max Days</div>
  <div class="head">TimeUnit</div>
  <div class="head">ApplyModel</div>
  <div class="head">Price/ngày</div>

  @for (var i = 0; i < (Model.PriceRules?.Count ?? 0); i++)
  {
    var r = Model.PriceRules[i];
    <div class="rules-row">
      <input type="datetime-local" name="PriceRules[@i].ValidFrom" value="@r.ValidFrom.ToString("yyyy-MM-ddTHH:mm")" />
      <input type="datetime-local" name="PriceRules[@i].ValidTo"   value="@(r.ValidTo?.ToString("yyyy-MM-ddTHH:mm"))" />

      <input type="number" step="0.001" name="PriceRules[@i].MinVolumeM3" value="@(r.MinVolumeM3?.ToString())" />
      <input type="number" step="0.001" name="PriceRules[@i].MaxVolumeM3" value="@(r.MaxVolumeM3?.ToString())" />

      <input type="number" step="0.001" name="PriceRules[@i].MinAreaM2"   value="@(r.MinAreaM2?.ToString())" />
      <input type="number" step="0.001" name="PriceRules[@i].MaxAreaM2"   value="@(r.MaxAreaM2?.ToString())" />

      <input type="number" step="0.001" name="PriceRules[@i].MinQty"      value="@(r.MinQty?.ToString())" />
      <input type="number" step="0.001" name="PriceRules[@i].MaxQty"      value="@(r.MaxQty?.ToString())" />

      <input type="number"              name="PriceRules[@i].MinDays"     value="@(r.MinDays?.ToString())" />
      <input type="number"              name="PriceRules[@i].MaxDays"     value="@(r.MaxDays?.ToString())" />

      <select name="PriceRules[@i].TimeUnit">
        <option value="0" selected="@(r.TimeUnit==TimeUnit.Day)">Day</option>
        <option value="1" selected="@(r.TimeUnit==TimeUnit.Week)">Week</option>
        <option value="2" selected="@(r.TimeUnit==TimeUnit.Month)">Month</option>
      </select>

      <select name="PriceRules[@i].ApplyModel">
        <option value="0" selected="@(r.ApplyModel==PricingModel.Flat)">Flat</option>
        <option value="1" selected="@(r.ApplyModel==PricingModel.PerUnit)">PerUnit</option>
        <option value="2" selected="@(r.ApplyModel==PricingModel.Tiered)">Tiered</option>
        <option value="3" selected="@(r.ApplyModel==PricingModel.DimensionBased)">DimensionBased</option>
        <option value="4" selected="@(r.ApplyModel==PricingModel.TimeBased)">TimeBased</option>
      </select>

      <input type="number" step="0.01" name="PriceRules[@i].Price" value="@r.Price" />
    </div>
  }
</div>

<div style="margin-top:8px">
  <button type="button" class="btn" id="btnAddRule">+ Thêm rule</button>
</div>

<script>
(function(){
  const grid = document.getElementById('rulesGrid');
  const btn  = document.getElementById('btnAddRule');
  if(!grid || !btn) return;

  btn.addEventListener('click', () => {
    const i = grid.querySelectorAll('.rules-row').length;
    const row = document.createElement('div');
    row.className = 'rules-row';
    row.innerHTML = `
      <input type="datetime-local" name="PriceRules[${i}].ValidFrom" />
      <input type="datetime-local" name="PriceRules[${i}].ValidTo" />
      <input type="number" step="0.001" name="PriceRules[${i}].MinVolumeM3" />
      <input type="number" step="0.001" name="PriceRules[${i}].MaxVolumeM3" />
      <input type="number" step="0.001" name="PriceRules[${i}].MinAreaM2" />
      <input type="number" step="0.001" name="PriceRules[${i}].MaxAreaM2" />
      <input type="number" step="0.001" name="PriceRules[${i}].MinQty" />
      <input type="number" step="0.001" name="PriceRules[${i}].MaxQty" />
      <input type="number" name="PriceRules[${i}].MinDays" />
      <input type="number" name="PriceRules[${i}].MaxDays" />
      <select name="PriceRules[${i}].TimeUnit">
        <option value="0">Day</option><option value="1">Week</option><option value="2">Month</option>
      </select>
      <select name="PriceRules[${i}].ApplyModel">
        <option value="0">Flat</option><option value="1">PerUnit</option>
        <option value="2">Tiered</option><option value="3">DimensionBased</option><option value="4">TimeBased</option>
      </select>
      <input type="number" step="0.01" name="PriceRules[${i}].Price" />
    `;
    grid.appendChild(row);
  });
})();
</script>
